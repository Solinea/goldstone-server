<!--
 Copyright 2014 Solinea, Inc.

 Licensed under the Solinea Software License Agreement (goldstone),
 Version 1.0 (the "License"); you may not use this file except in compliance
 with the License. You may obtain a copy of the License at:

     http://www.solinea.com/goldstone/LICENSE.pdf

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Author: John Stanford
 -->

{% extends "base.html" %}
{% load staticfiles %}
{% load custom_filters %}

{% block localcss %}
{% endblock %}

{% block localjs %}
    <script src="{% static 'nova/js/nova.js' %}"></script>
    <script src="{% static 'neutron/js/neutron.js' %}"></script>
    <script src="{% static 'keystone/js/keystone.js' %}"></script>
    <script src="{% static 'glance/js/glance.js' %}"></script>
    <script src="{% static 'cinder/js/cinder.js' %}"></script>
    <script src="{% static 'api_perf/js/api_perf.js' %}"></script>
    <script>
$(document).ready(function () {
    var nsReport = goldstone.apiPerf.report;
    var nsNovaApiPerf = goldstone.nova.apiPerf;
    var nsNeutronApiPerf = goldstone.neutron.apiPerf;
    var nsKeystoneApiPerf = goldstone.keystone.apiPerf;
    var nsGlanceApiPerf = goldstone.glance.apiPerf;
    var nsCinderApiPerf = goldstone.cinder.apiPerf;

    nsReport.start = goldstone.time.fromPyTs({{ start_ts|to_js }});
    nsReport.end = goldstone.time.fromPyTs({{ end_ts|to_js }});
    nsReport.interval = {{ interval|to_js }}

    nsNovaApiPerf.bivariate = goldstone.charts.bivariateWithAverage._getInstance(nsNovaApiPerf);
    nsNeutronApiPerf.bivariate = goldstone.charts.bivariateWithAverage._getInstance(nsNeutronApiPerf);
    nsKeystoneApiPerf.bivariate = goldstone.charts.bivariateWithAverage._getInstance(nsKeystoneApiPerf);
    nsGlanceApiPerf.bivariate = goldstone.charts.bivariateWithAverage._getInstance(nsGlanceApiPerf);
    nsCinderApiPerf.bivariate = goldstone.charts.bivariateWithAverage._getInstance(nsCinderApiPerf);

    // render charts:
    /*nsNovaApiPerf.bivariate.loadUrl(nsReport.start, nsReport.end, nsReport.interval,
            true, '#api-perf-report-r1-c1');
    nsNeutronApiPerf.bivariate.loadUrl(nsReport.start, nsReport.end, nsReport.interval,
            true, '#api-perf-report-r1-c2');
    nsKeystoneApiPerf.bivariate.loadUrl(nsReport.start, nsReport.end, nsReport.interval,
            true, '#api-perf-report-r2-c1');
    nsGlanceApiPerf.bivariate.loadUrl(nsReport.start, nsReport.end, nsReport.interval,
            true, '#api-perf-report-r2-c2');*/
    nsCinderApiPerf.bivariate.loadUrl(nsReport.start, nsReport.end, nsReport.interval,
            true, '#api-perf-report-r3-c1');


    //------------------------------
    // begin backbone refactor test:

    var demoChart = new ApiPerfCollection({});
    var demoChartView = new ApiPerfView({model: demoChart});
    demoChart.fetch();


    // function to create urls that advance at adjustable rates
    var timeMock = function(){
        // enter unix time/1000 of start moment
        var urlNumBase = 1409006640;
        // sets the end time to about 75 minutes to the start time
        var urlNumBase2 = urlNumBase + 4592;

        return function(){
            // advances 4 minutes per invocation
            var advanceRate = 240;
            urlNumBase += advanceRate;
            urlNumBase2 += advanceRate;

            // returns new url to query for data payload
            var result = "/nova/api_perf?start=" + urlNumBase + "&end=" + urlNumBase2 + "&interval=120s&render=false";
            return result;
        };
    };
    var timeAdvancer = timeMock();


    var graphUpdater = setInterval(function(){

        // call timeAdvancer which stores the urlNumBase in a closure scope
        var newTime = timeAdvancer();
        demoChart.url = newTime;

        console.log('fetching again', demoChart.url);

        demoChart.fetch({success:function(data){
            // console.log(data);
        }});
    }, 2000);

    setTimeout(function(){
        console.log('auto update interval cleared');
        clearInterval(graphUpdater);
    },300000);

    // end backbone refactor test
    //---------------------------

});

    </script>

{% endblock %}


{% block content %}

    <div id="api-perf-report-r1" class="row">
        <div id="api-perf-report-r1-c1" class="col-md-6"></div>
        <div id="api-perf-report-r1-c2" class="col-md-6"></div>
    </div>
    <div id="api-perf-report-r2" class="row">
        <div id="api-perf-report-r2-c1" class="col-md-6"></div>
        <div id="api-perf-report-r2-c2" class="col-md-6"></div>
    </div>
    <div id="api-perf-report-r3" class="row">
        <div id="api-perf-report-r3-c1" class="col-md-6"></div>
        <div id="api-perf-report-r3-c2" class="col-md-6"></div>
    </div>

{% endblock %}
