---
## test machine configuration
machine:
  pre:
    # cp workaround from https://discuss.circleci.com/t/unable-to-use-docker-cp-but-it-worked-2-days-ago/1137/9
    - echo 'DOCKER_OPTS="-s btrfs -e lxc -D --userland-proxy=false"' | sudo tee -a /etc/default/docker
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci-cp-workaround'
    - sudo chmod 0755 /usr/bin/docker
  python:
    version: 2.7.10
  services:
    - docker
  # environment variables
  environment:
    # build output dirs
    LOG_DIR:      $CIRCLE_ARTIFACTS/logs
    DJANGO_DIR:   $CIRCLE_TEST_REPORTS/django
    # build_images support
    GS_PROJ_TOP_DIR:    $HOME/goldstone-server
    # Docker image directories for staging
    DOCKER_DIR:   $GS_PROJ_TOP_DIR/docker
    # Docker runtime args
    COMPOSE_CONF: $DOCKER_DIR/docker-compose-ci.yml

## custom checkout
checkout:
  post:
    - git submodule init
    - git submodule update

## custom dependencies
dependencies:
  pre:
    - mkdir -p {$LOG_DIR,$DJANGO_DIR}             # create output directories
    - sudo service postgresql stop                # stop default postgresql service
    - sudo service redis-server stop              # stop default redis-server service
    - pip install -U pip setuptools virtualenv    # circleci env fix, if specifying python version
    - sudo pip install docker-compose             # circleci env fix, install docker-compose
    - docker info && docker-compose version

## test config
test:
  override:
    - /bin/true

## deployment config
deployment:
  release:
    # pattern of 1, 1.2, 1.2.3
    tag: /[0-9]+(\.[0-9]+)*/
    commands:
      - echo "stable, $CIRCLE_TAG"
      # TODO: replace with full tag/push when merged with solinea/goldstone-server
      #- docker tag goldstone-app gs-docker-oss.bintray.io/app:$CIRCLE_BRANCH
      #- docker tag goldstone-app gs-docker-oss.bintray.io/app:stable
      #- docker push gs-docker-oss.bintray.io/app:$CIRCLE_BRANCH
      #- docker push gs-docker-oss.bintray.io/app:stable
  latest:
    branch: master
    commands:
      - mkdir -p $CIRCLE_ARTIFACTS/ubuntu $CIRCLE_ARTIFACTS/redhat
      - docker info
      - docker build -t gss.rpm -f rpm_packaging/Dockerfile.rpm .
      - docker run --name gss-rpm gss.rpm make rpm_native
      - docker cp gss-rpm:/tmp/goldstone-server/`bin/semver.sh rpmname goldstone-server` $CIRCLE_ARTIFACTS/redhat/
      - docker run --name gsse-rpm gss.rpm make gse_native
      - docker cp gsse-rpm:/tmp/goldstone-server/`bin/semver.sh rpmname goldstone-server-enterprise` $CIRCLE_ARTIFACTS/redhat/
      # TODO: replace with full tag/push when merged with solinea/goldstone-server
      #- docker tag goldstone-app gs-docker-oss.bintray.io/app:latest
      #- docker tag goldstone-app gs-docker-oss.bintray.io/app:$CIRCLE_BRANCH-${CIRCLE_SHA1:0:7}
      #- docker push gs-docker-oss.bintray.io/app:latest
      #- docker push gs-docker-oss.bintray.io/app:$CIRCLE_BRANCH-${CIRCLE_SHA1:0:7}
  dev:
    branch: /.*/
    commands:
      - mkdir -p $CIRCLE_ARTIFACTS/ubuntu $CIRCLE_ARTIFACTS/redhat
      - docker info
      - docker build -t gss.rpm -f rpm_packaging/Dockerfile.rpm .
      - docker run --name gss-rpm gss.rpm make rpm_native
      - docker cp gss-rpm:/tmp/goldstone-server/`bin/semver.sh rpmname goldstone-server` $CIRCLE_ARTIFACTS/redhat/
      - docker run --name gsse-rpm gss.rpm make gse_native
      - docker cp gsse-rpm:/tmp/goldstone-server/`bin/semver.sh rpmname goldstone-server-enterprise` $CIRCLE_ARTIFACTS/redhat/

general:
  artifacts:
    - $CIRCLE_ARTIFACTS
    - $CIRCLE_TEST_REPORTS
