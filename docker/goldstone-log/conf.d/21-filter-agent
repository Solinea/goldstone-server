# Copyright 2015 Solinea, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


filter {
    if [type] == "agent" {
        # is this a file integrity monitor event?
        if [fim]  {
            uuid {
                target => ["id"]
            }
            uuid {
                target => ["delivery_tag"]
            }
            uuid {
                target => ["correlation_id"]
            }
            uuid {
                target => ["reply_to"]
            }
            ruby {
                code => "require 'base64';
                         require 'json';
                         event['body'] = { :args => event['fim'].values_at('meta', 'doc'), 
                                           :task => 'goldstone.compliance.tasks.process_fim_event', 
                                           :id => event['id'] }.to_json.gsub(/\n/, '');
                         event['body'] = Base64.encode64(event['body']);
                         event['content-type'] = 'application/json';
                         event['properties'] = { :body_encoding => 'base64', 
                                                 :correlation_id => event['correlation_id'], 
                                                 :reply_to => event['reply_to'], 
                                                 :delivery_mode => 2, 
                                                 :delivery_tag => event['delivery_tag'], 
                                                 :delivery_info => { :priority => 0, 
                                                                     :routing_key => 'default', 
                                                                     :exchange => 'default' }};"
                remove_field => [ "fim", "@timestamp", "@version", "id", "correlation_id", "reply_to", "delivery_tag" ]
            }
        }
    }
}
